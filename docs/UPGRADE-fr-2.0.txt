==========================================================
=== Migration site de la Commune de Molenbeek - site18
==========================================================
http://www.molenbeek.be/
http://localhost:8080/site18/plone/
Molenbeek.fs

Procédure à effectuer sur la plateforme Plone 3.3.5
------------------------------------------------------

Travail réalisé sur les produits CIRB :
- Profile de désinstallation de acmolenbeek.site.

Au préalable :
- Sauvegarder la base de données.

* En ZMI :

  * portal_quickinstaller: uninstall Kupu, acmolenbeek.site
  * portal_skins: remove twolanguagesportlet
  * portal_skins/properties: remove twolanguagesportlet, cachesetup, kupu_tests, linguafaq_script, linguafaq_image

    * Two Languages Portlet

     -> Attention, ce portlet est utilisé dans le site et doit être supprimé :
          -> /site18/plone - left_slots
          -> /site18/plone - right_slots

          !!!!! Cela suprime beaucoup de contenu dans les deux colonnes.
          Note : le produit fonctionne en Plone 4.1.

      -> Désinstaller via le portal_quickinstaller
          -> supprime twolanguagesportlet de portal_skins
          -> supprime twolanguagesportlet des skins dans portal_skins > Properties
          -> supprime twolanguagesportlet.css de portal_css

    * collective.indexing

      * Désinstaller via le portal_quickinstaller

      * Pour supprimer complètement le produit, ajouter au buildout (egg+zcml) wildcard.fixpersistentutilities.
        Se rendre à la page site18/plone/@@activate-expert-mode-for-fixing-persistent-utilities et supprimer
        tout ce qui est relatif à collective.indexing :
        - <InterfaceClass collective.indexing.indexer.IPortalCatalogQueueProcessor> -> 3 occurences
        - <InterfaceClass collective.indexing.interfaces.IIndexingConfig> -> 2 occurences

    * TinyMCE Editor Support -> Désinstaller via le portal_quickinstaller

    * acmolenbeek.site

      * Supprimer tout le contenu de portal_skins/custom.

      * Désinstaller acmolenbeek.site via le portal_quickinstaller.
        -> supprime les actions spécifiques au site du groupe "portal_tabs" et réinitialise celles du group "user"
        -> supprime +++resource++acmolenbeek.site.stylesheets/main.css de portal_css
        -> supprime acmolenbeek_site_custom_images / acmolenbeek_site_custom_templates / acmolenbeek_site_styles de portal_skins
        -> supprime acmolenbeek_site_custom_images / acmolenbeek_site_custom_templates / acmolenbeek_site_styles > Properties

      * Passer le portal_css en mode "Debug/development"

      * Supprimer le cache de votre navigateur et forcer le rechargement d'une des pages du site (/front-page).

      * Désativer le mode "Debug/development" dans le portal_css.

      ==> Le site est opérationnel avec la skin par défaut de Plone.

    * Packer la base de données.

    * Copier la base de données Molenbeek.fs sur la plateforme Plone 4.1

Procédure à effectuer sur la plateforme Plone 4.1
------------------------------------------------------

Au préalable :
- Faire une copie de la base de données.

IMPORTANT - Il est nécessaire de configurer un blobstorage pour notre base de données dans le buildout.
            Nous l'avons fait dans base.cfg (rechercher "blobstorage-molenbeek" - 2 occurences).
            Plus d'informations sur la configuration en mode zeo et non-zeo : http://dev.plone.org/plone/ticket/10130
            Remarque: il est nécessaire de relancer le buildout.

Le fichier base.cfg que nous utilisons pour le développement comprends la liste des addons (egg+zcml).
Il est combiné au fichier versions.cfg qui fixe les versions de chaque module additionnel.

NOTE POUR MAC : beaucoup d'erreur lors la mise à jour de Plone lié à l'absence du binaire pdftotext
                => solution: port install poppler

* En ZMI

    * Mettre à jour le site Plone - site18/plone/@@plone-upgrade (faire un "Mode de test" au préalable!).
      Etudier les logs pour vérifier que tout est bon.

    * Reconstruire le catalogue : portal_catalog > Advanced > Clear and Rebuild

    * Migrer les types de contenu existants (fichiers et images) vers blob via (il faut parfois s'y prendre à plusieurs reprises):
      - /site18/plone/@@blob-file-migration
      - /site18/plone/@@blob-image-migration
      IMPORTANT : Il y a des erreurs empêchant la migration d'être complète.
                  Exemple :
                      Failed migration for object /site4/plone/berchem-sainte-agathe-nl/bestanden/espaces-publics (File -> File)
                      ...
                          raise CopyError(eNotSupported % escape(id))
                      CopyError:
                      ...
                  ==> L'erreur est dûe par exemple à un fichier en langue "fr" au sein d'un dossier "nl".
                      Il est nécessaire de corriger (ou supprimer) manuellement ces fichiers et de relancer la migration.

    * Traiter les modules installés via /site18/plone/prefs_install_products_form
      - Mettre à jour "PloneFormGen"
      - Mettre à jour "Support des copies de travail (Iterate)"
      - Vous pouvez désinstaller "Kupu"
      - Installer/configurer les produits souhaités

    * Installation de la version Plone 4.1 de acmolenbeek.site.

    * Créer une alternative aux portlets "Two Languages Portlet" supprimés dans la première partie de la migration.

* Penser à configurer l'éditeur par défaut du site: /@@editing-controlpanel
* Penser à activer les liens par UID: /portal_tinymce/@@tinymce-controlpanel
  Idem si utilisation de CKEditor.

* Problèmes rencontrés :

    * Les liens du site Plone 3.3.5 utilisent des paths relatifs (ex: ../images/mon-image.jpg),
      cela ne pose pas de problème à l'affichage mais certaines images peuvent être en erreurs quand
      on est en édition.

      Solution partielle : installer Products.kupu 1.5.0 et lancer l'utilitaire de convertion
                           de convertion des paths relatifs vers uuid (convertion partielle des
                           contenus).

      Conseil : utiliser l'éditeur de texte TinyMCE qui est fournit avec Plone et qui
                aura une meilleure pérennitée.


Note:

- Un comportement inattendu a lieu avec les liens Accueil/Home du path_bar et de la barre de menu
  horizontal (mélange fr/nl) sûrement lié au fait que les deux liens mènent à la même url quelque soit la
  langue (problème de cache). Le problème intervient également sur le site actuel http://www.molenbeek.be/.
  ---> nous avons adapté les liens Accueil/Home pour le path_bar (cf. path_bar.pt) et la barre de menu
       vertical (cf. actions.xml).

Notes et dysfonctionnement :
** Pour chacun des points, merci de nous indiquer si vous souhaitez que l'on investisse du temps **
- Petite différences dans le plan du site (manque des icônes).
- Petite différence dans le portlet "Evénements à venir": il n'y a plus d'icône dans le portlet,
  et par conséquent plus de décalage vers la droite (les icônes étaient cachées par css).
  --> souhaitez-vous forcer un décalage ?

Tests très rapide, qui seront plus poussés si on conserve le thème actuel :
Remarques générales : - amélioration du placement du résultat "livesearch".
- IE 7 - ok en consultation,
         bug mineur de mise en page: sitemap
- IE 8 - ok
- IE 9 - ok
- Firefox - ok
- Chrome - ok
- Safari - ok